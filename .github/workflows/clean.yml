name: clean

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 0"

jobs:
  clean:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: write
      
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: clean release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git fetch --tags
          
          threshold=$(date --date="-90 days" +%s)
          
          gh release list --json tagName,createdAt,isDraft --limit 100 \
          | jq -r --argjson threshold "$threshold" '
              .[] | 
              select(
                ((.createdAt | fromdateiso8601) < $threshold or .isDraft == true) and
                .tagName != "" and
                .tagName != null and
                (.tagName | type == "string")
              ) | 
              .tagName
          ' \
          | while IFS= read -r tag; do
              if [ -n "$tag" ]; then
                for attempt in {1..3}; do
                  if git tag --list | grep -Fx "$tag" > /dev/null; then
                    timeout 30s bash -c "gh release delete \"$tag\" --yes && git tag -d \"$tag\" && git push origin --delete refs/tags/\"$tag\"" && break || {
                      if [ $attempt -lt 3 ]; then
                        sleep 2
                      fi
                    }
                  else
                    timeout 30s gh release delete "$tag" --yes && break || {
                      if [ $attempt -lt 3 ]; then
                        sleep 2
                      fi
                    }
                  fi
                done
              fi
            done